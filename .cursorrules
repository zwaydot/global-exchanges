# Global Exchanges 项目开发规范

本文档说明如何在本仓库进行开发、自测、提交变更日志以及发布上线，并包含关键技术栈（Globe.gl/Three.js）的实战经验总结。

## 1. 项目结构
- `apps/`: 服务端子项目 (do, mailer, main, prom, stream, task)
- `packages/`: 共享库 (driven-common, eslint-config, etc.)
- `components/`: 前端 React 组件 (GlobeViz 等)
- `lib/`: 共享业务逻辑模块
  - `marketTicker.ts`: FMP Ticker 数据刷新逻辑（可被 API 和 Cron Worker 共用）
  - `exchangeStats.ts`: WFE 交易所统计数据解析逻辑
- `functions/api/`: Cloudflare Pages Functions API 端点
  - `market-ticker.ts`: 股票行情 API，从 KV 缓存读取或调用 FMP API
- `workers/`: Cloudflare Workers（定时任务）
  - `exchange-cron.ts`: 定时刷新任务（Ticker 和 Exchange Stats）

## 2. 开发流程
- **Hotfix**: 从 `prod` 切出 -> 开发 -> `pnpm changeset:new` -> 提交 PR 到 prod & staging
- **Feature**: 从 `staging` 切出 -> 开发 -> `pnpm changeset:new` -> 提交 PR 到 staging
- **本地启动**: 根目录 `pnpm i` -> `pnpm dev` (需配置环境变量)

## 3. 关键技术经验总结：Globe.gl & Three.js

在本项目中，我们使用 `react-globe.gl` 结合 `three.js` 实现 3D 地球可视化。以下是在定制样式和解决由于版本/初始化时机导致的问题时总结的最佳实践：

### 3.1 初始化与生命周期
- **避免依赖 `onGlobeReady`**: 该回调在某些版本或特定加载顺序下可能不会触发。
- **推荐初始化方式**: 使用 `useEffect` 并在组件挂载后，配合 `setTimeout` (如 100ms) 延迟访问 `globeEl.current`。
- **空指针保护**: 在访问 `globeEl.current` 或其内部 `scene()`/`controls()` 之前，务必进行判空检查。

### 3.2 材质与样式定制 (Material Customization)
- **安全访问材质**: `globe.globeMaterial()` 方法在某些情况下可能报错或不可用。
  ```typescript
  // 错误做法
  const mat = globe.globeMaterial(); // 可能抛出 TypeError
  
  // 正确做法 (Try-Catch + 类型检查)
  try {
    const mat = globe.globeMaterial();
    if (mat && mat instanceof THREE.MeshPhongMaterial) {
       // ...设置属性
    }
  } catch (e) { console.warn(e); }
  ```
- **异步纹理覆盖问题**: 地球纹理加载是异步的，可能会覆盖掉我们手动设置的材质属性（如 `emissive` 自发光）。
  - **解决方案**: 使用**重试机制**，在初始化后的不同时间点（如 1s, 3s）多次执行材质更新逻辑，确保最终样式生效。
- **亮度调整最佳实践**:
  - **组合策略**: 同时调整光照（AmbientLight + DirectionalLight）和材质（emissive + specular），效果更明显
  - **渐进式调整**: 先小幅提升（如环境光 1.5 → 2.0），如果效果不明显再大幅提升（2.0 → 2.8）
  - **避免过曝**: 自发光强度不要超过 0.6，否则会失去细节和层次感
  - **多光源**: 使用 2-3 个不同方向的定向光，可以消除暗部死角，让地球更立体

### 3.3 场景与光照 (Scene & Lighting)
- **提升亮度**: 默认光照较暗。建议手动向场景添加 `AmbientLight` (环境光, 强度 > 1.0) 和 `DirectionalLight` (定向光)。
  - **推荐配置**:
    - `AmbientLight`: 强度 2.5-3.0（提供全局基础亮度）
    - `DirectionalLight`: 强度 3.5-4.0（主光源，提供方向性高光）
    - 可添加第二个 `DirectionalLight`（强度 2.0）从另一侧照射，消除阴影死角
  - **材质自发光 (Emissive)**:
    - 设置 `emissive` 颜色为 `0x444444` 或更高（如 `0x555555`）
    - `emissiveIntensity` 设置为 `0.4-0.5`（过高会过曝）
    - 配合 `specular` 高光反射（如 `0x222222`）增强立体感
  - **验证亮度调整**: 对比线上版本，确保暗部细节可见，整体亮度有明显提升
- **自定义背景 (Stars)**:
  - 不要使用 `backgroundImageUrl` (静态且难以控制)。
  - 推荐直接创建 `THREE.Points` 添加到 `scene` 中。
  - **关键设置**: 设置 `renderOrder = -1` 和 `depthWrite: false`，确保星星作为背景渲染，不会遮挡地球。
  - **透明背景**: 将 `<Globe>` 组件的 `backgroundColor` 设置为 `"rgba(0,0,0,0)"`，以便自定义的 Three.js 背景能正确显示。
  - **星星大小和亮度变化**: 创建多个 `Points` 对象，每组使用不同的 `size`（如 1.2, 2.0, 3.5），并通过 `vertexColors: true` 为每个星星设置不同的颜色（亮度），模拟真实星空效果

### 3.4 交互与性能
- **渲染循环**: 如果在 `useEffect` 中开启了自定义的 `requestAnimationFrame` 循环，请确保组件卸载时正确清理。
- **事件监听**: 鼠标交互事件（如 hover）应配合 `useRef` 存储状态，避免频繁触发 React 重渲染导致 Globe 实例重建。

## 4. FMP Ticker 数据更新机制

### 4.1 架构设计
- **共享模块**: `lib/marketTicker.ts` 提供统一的数据刷新逻辑，可被 API endpoint 和 Cron Worker 共用
- **定时刷新**: 通过 `exchange-cron` Worker 每天 UTC 22:00 自动刷新（美股收盘后 1-2 小时）
- **缓存策略**: KV 缓存 TTL 设置为 48 小时，作为保险机制（如果 Cron 连续失败，用户访问时会触发刷新）

### 4.2 FMP API 限制
- **免费计划**: 只提供 End of Day (EOD) 数据，即前一天的收盘数据
- **刷新频率**: 每天刷新一次即可，无需实时更新
- **Rate Limit**: 免费计划有调用限制，代码中已加入 250ms 延迟避免触发 429

### 4.3 数据流程
```
Cron Worker (UTC 22:00) 
  → fetchTickerFromFMP() 
    → 调用 FMP API 
      → writeTickerCache() 
        → 写入 KV

用户访问 /api/market-ticker 
  → readTickerCache() 
    → 检查 isTickerCacheFresh() 
      → 新鲜：直接返回 KV 数据
      → 过期：调用 FMP API 刷新
```

### 4.4 配置要求
- **Cloudflare Dashboard**: 需要在 `exchange-cron` Worker 的 Settings → Variables 中配置 `FMP_API_KEY`（加密存储）
- **本地开发**: 在 `.env` 文件中配置 `FMP_API_KEY`（已添加到 `.env.example`）

### 4.5 最佳实践
- **不要频繁刷新**: FMP 免费计划只提供 EOD 数据，每天刷新一次足够
- **缓存优先**: 用户访问时优先使用 KV 缓存，减少 API 调用
- **错误处理**: 如果 API 调用失败，返回旧缓存数据（总比没有数据好）
- **日志记录**: 所有关键操作都有日志，便于调试和监控

## 5. 鼠标轨迹动画（Cursor Trail）

- **组件位置**: `components/CursorTrail.tsx`
- **技术方案**: Canvas 2D + `requestAnimationFrame`，使用 `useRef` 避免 React 重渲染
- **关键设置**: 
  - `pointer-events-none`: 不干扰页面交互
  - `z-50`: 最上层显示
  - `mixBlendMode: 'screen'`: 增强发光效果
- **颜色方案**: 随机选择 Cyan-400、Amber-400 或白色，与主题色保持一致
- **性能**: 及时清理死亡粒子，组件卸载时移除事件监听和取消动画帧

## 6. 交易所快照功能（Exchange Snapshot）

### 6.1 功能概述
当用户点击交易所名称时，会在详情面板顶部显示一个包含实时天气、市场数据和 3D 建筑场景的垂直卡片。

### 6.2 核心组件
- **组件位置**: `components/ExchangeSnapshot.tsx`
- **API 端点**: `functions/api/generate-snapshot.ts` (Cloudflare Pages Function)
- **本地开发代理**: `vite-plugin-api.ts` 中的 `/api/generate-snapshot` 路由
- **数据映射**: `lib/exchangeMapping.ts` - 包含所有 88+ 交易所的坐标、指数代码、建筑描述

### 6.3 数据获取流程
```
用户点击交易所
  → ExchangeSnapshot 组件调用 /api/generate-snapshot?exchange={name}
    → 并行获取：
      1. Open-Meteo API: 实时天气 + 当地时区时间 (timezone=auto)
      2. Gemini Flash Latest: 通过 Google Search 获取实时指数数据
      3. Gemini 3 Pro Image Preview: 生成 3D 建筑场景图片
    → 返回 JSON: { weather, market, imageUrl }
```

### 6.4 关键技术点

#### 6.4.1 实时天气与时区
- **API**: Open-Meteo (`https://api.open-meteo.com/v1/forecast`)
- **关键参数**: `timezone=auto` - 自动根据经纬度返回当地时区时间
- **返回字段**: `is_day` (0=夜晚, 1=白天), `time` (ISO 格式本地时间)
- **用途**: 决定图片生成是白天还是夜景，以及前端文字颜色（白天用黑色，夜晚用白色）

#### 6.4.2 市场指数数据
- **主要方法**: Gemini Flash Latest (`gemini-flash-latest`) + Google Search 工具
- **备用方法**: FMP API (仅支持以 `^` 开头的符号，免费版限制较多)
- **数据格式**: `{ price, change, changePercent }`
- **JSON 解析**: 使用容错机制，自动修复单引号、未加引号的键等常见错误

#### 6.4.3 3D 图片生成
- **模型**: `gemini-3-pro-image-preview` (Nano Banana Pro)
- **Prompt 设计**:
  - 明确禁止生成任何文字、数字、标签（文字由前端叠加）
  - 控制天空区域占比（20-25%）为文字预留空间
  - 根据天气和时间动态调整光照和氛围描述
- **输出格式**: Base64 data URL (PNG, 1K 分辨率, 3:4 比例)

#### 6.4.4 前端 UI 特性
- **日夜自适应文字**: 根据 `isDay` 自动切换文字颜色和背景
- **Shiny Text 效果**: 日期/天气行使用 CSS 渐变动画（2 秒循环）
- **复制到剪贴板**: 使用 `@zumer/snapdom` 库将整个卡片转为 PNG
- **状态管理**: Loading → Success/Error，带详细错误提示

### 6.5 环境变量配置
- **GEMINI_API_KEY**: 必需，用于图片生成和市场数据搜索
- **FMP_API_KEY**: 可选，作为市场数据的备用方案
- **本地开发**: 在 `.env` 或 `.dev.vars` 中配置
- **生产环境**: Cloudflare Pages → Settings → Environment Variables

### 6.6 交易所映射维护
- **文件**: `lib/exchangeMapping.ts`
- **关键字段**:
  - `lat`, `lon`: 用于天气 API 和时区计算
  - `indexSymbol`: 市场指数代码（如 `^DJI`, `^HSI`）
  - `indexName`: 显示名称（如 "Dow Jones", "Hang Seng Index"）
  - `buildingPrompt`: 用于图片生成的建筑描述
- **命名一致性**: 确保 `constants.ts` 中的交易所名称与映射表的 key 完全匹配
- **新增交易所**: 需要同时更新 `constants.ts` 和 `exchangeMapping.ts`

### 6.7 最佳实践
- **缓存策略**: 图片生成较慢，前端使用 timestamp 参数强制刷新
- **错误处理**: 所有 API 调用都有 try-catch，失败时显示友好错误信息
- **性能优化**: 并行获取天气和市场数据，减少总等待时间
- **可访问性**: 图片有 alt 文本，按钮有 title 提示

## 7. 分析与埋点（Umami）
- **技术栈**: Umami Cloud（prod: deepstock.pro, staging: staging.deepstock.pro），通过 `index.html` 动态按域名加载脚本并设置 data-domains。
- **自定义事件**: `exchange_click`（含 exchange/name/source）、`marker_click`、`copy_image`、`panel_open`、`panel_close`、`cta_twitter`、`cta_driven`、`cta_leaderboard`。
- **页面 PV**: `trackPageView` 在非本地调用 `umami.track('page_view')`，本地跳过；其余事件均在各组件调用 `trackUmami`。
- **避免重复上报**: `onCustomLayerClick` 只触发一次 `exchange_click`（source=custom_layer），避免双计数。
- **本地/预览隔离**: 非白名单域名不加载脚本，防止开发流量污染；若需新增环境，请在 `index.html` 域名映射中添加对应 website-id。

---
*Last Updated: 2025-12-06*

